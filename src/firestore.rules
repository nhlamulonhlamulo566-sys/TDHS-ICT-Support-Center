
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ───────────────────────────────────────
    // Helper Functions (must be defined before use)
    // ───────────────────────────────────────
    function isSignedIn() {
      return request.auth != null;
    }

    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function userRole() {
      return isSignedIn()
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : null;
    }

    function isRole(role) {
      return userRole() == role;
    }

    // check userRole in an array of allowed roles
    function isOneOf(roles) {
      return userRole() in roles;
    }
    
    // Checks if the only field being modified is the one specified.
    // It compares the incoming data keys with the existing data keys to ensure only the allowed field is changing.
    function isOnlyChanging(fieldName) {
      let changedKeys = request.resource.data.diff(resource.data).affectedKeys();
      // Allow if only the specified field is changed, or if it's changed alongside 'updatedAt' (common practice)
      return changedKeys.hasOnly([fieldName]) || changedKeys.hasAll([fieldName, 'updatedAt']);
    }

    // ───────────────────────────────────────
    // PUBLIC COLLECTIONS
    // ───────────────────────────────────────

    // Tickets: Public may create & GET by ID (for tracking), but cannot list
    match /tickets/{ticketId} {
      // Public can create (public form)
      allow create: if true;

      // Public can read a specific ticket by ID (public tracking page)
      allow get: if true;

      // Listing (queries) only allowed for signed-in users (staff/admin dashboard)
      allow list: if isSignedIn();

      // Staff update access
      allow update: if isOneOf(["Admin", "Supervisor", "Technician", "Help Desk"]);

      // Only admin can delete
      allow delete: if isRole("Admin");
    }

    // Counters: required for atomic ticket-number generation
    match /counters/{counterId} {
      // Transactions must be able to read the counter
      allow get: if true;

      // Writes: only allow safe increments by exactly +1 (prevents arbitrary overwrite)
      // If counter doesn't exist (resource.data.count == null) only allow setting to 1
      // If it exists, allow only when request.resource.data.count == resource.data.count + 1
      allow write: if (
        // writing only the 'count' field (no extra keys)
        request.resource.data.keys().hasOnly(['count'])
        &&
        (
          // new creation case (counter did not exist before)
          (!exists(/databases/$(database)/documents/counters/$(counterId)) && request.resource.data.count == 1)
          ||
          // existing counter increment by one
          (exists(/databases/$(database)/documents/counters/$(counterId)) &&
            request.resource.data.count == resource.data.count + 1)
        )
      );

      // No listing counters
      allow list: if false;
    }

    // ───────────────────────────────────────
    // AUTH-ONLY HELPERS & RULES
    // ───────────────────────────────────────
    match /users/{userId} {
      // authenticated users can read profile info
      allow get, list: if isSignedIn();

      // Only admins can create user documents
      allow create: if isRole("Admin");

      // Admin can update any user document.
      // A user can update their own availability or last login timestamp, but nothing else.
      allow update: if isRole("Admin") || 
        (
          isUser(userId) &&
          (
            // Rule for updating 'availability'
            isOnlyChanging('availability')
            ||
            // Rule for updating 'lastLoginAt'
            isOnlyChanging('lastLoginAt')
          )
        );

      // direct deletion disabled, must be done via disabling account
      allow delete: if false;
    }
  }
}
